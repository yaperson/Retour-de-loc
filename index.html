<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Contr√¥le Mat√©riel M√©dical</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: auto;
            padding: 1rem;
        }

        h1 {
            text-align: center;
        }

        label,
        select {
            display: block;
            margin-top: 1rem;
            font-weight: bold;
        }

        .questions {
            margin-top: 1rem;
        }

        .question {
            margin-bottom: 1.5rem;
        }

        .buttons-choices button {
            font-size: 1.2rem;
            padding: 0.5rem 1rem;
            margin-right: 1rem;
            border-radius: 5px;
            border: 1px solid #888;
            cursor: pointer;
        }

        .buttons-choices button.selected {
            background-color: #4caf50;
            color: white;
            border-color: #4caf50;
        }

        input[type="file"] {
            margin-top: 0.5rem;
        }

        img.preview {
            max-width: 100%;
            margin-top: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .notes_container {
            display: none;
        }

        .notes_container textarea {
            width: 100%;
            height: 20vh;
        }

        #btnSummary {
            margin-top: 2rem;
            width: 100%;
            font-size: 1.3rem;
            padding: 0.8rem;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        #btnSummary:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }

        /* --- Modale styles --- */
        #modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #00000088;
            z-index: 1000;
        }

        #modal>div {
            background: white;
            margin: 5% auto;
            padding: 1rem;
            max-width: 600px;
            height: 90%;
            overflow-y: auto;
            border-radius: 8px;
            position: relative;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        #closeModal {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 1.2rem;
            background: transparent;
            border: none;
            cursor: pointer;
        }

        #modal button {
            margin: 0.5rem;
            padding: 0.6rem 1rem;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            transition: background-color 0.2s;
        }

        #modal button:hover {
            background-color: #ddd;
        }

        /* Pour que les images dans le r√©sum√© prennent toute la largeur max */
        #modalContent img {
            max-width: 100%;
            margin-top: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        /* Titres dans le r√©sum√© */
        #modalContent h1,
        #modalContent h2 {
            text-align: center;
            margin-top: 1rem;
        }

        #modalContent .question-summary {
            margin-bottom: 1rem;
        }

        #modalContent .label {
            font-weight: bold;
            margin-top: 1rem;
            display: block;
        }
    </style>
</head>

<body>

    <h1>Contr√¥le Mat√©riel M√©dical</h1>

    <label for="typeMateriel">Choisir le type de mat√©riel :</label>
    <select id="typeMateriel" required>
        <option value="">-- S√©lectionner --</option>
        <option value="lit">Lit m√©dicalis√©</option>
        <option value="fauteuil_manuel">Fauteuil roulant manuel</option>
        <option value="fauteuil_electrique">Fauteuil roulant √©lectrique</option>
        <option value="leve_personne">L√®ve-personne / verticalisateur</option>
        <option value="autre">Autre</option>
    </select>

    <div id="questionsContainer" class="questions"></div>

    <div class="notes_container" id="notes_container">
        <label for="notes">Notes :</label>
        <textarea name="notes" id="notes"></textarea>
    </div>

    <div id="photosContainer" style="margin-top:1.5rem; display:none;">
        <label>Photo de l'ensemble :</label>
        <input type="file" accept="image/*" capture="environment" id="photoEnsemble" />
        <img id="previewEnsemble" class="preview" alt="Aper√ßu photo ensemble" />

        <label>Photo de l'√©tiquette (n¬∞ de s√©rie) :</label>
        <input type="file" accept="image/*" capture="environment" id="photoEtiquette" />
        <img id="previewEtiquette" class="preview" alt="Aper√ßu photo √©tiquette" />
    </div>

    <button id="btnSummary" disabled>Voir r√©sum√© & Partager</button>

    <!-- Modale r√©sum√© -->
    <div id="modal">
        <div>
            <button id="closeModal" title="Fermer la fen√™tre">‚úñÔ∏è</button>
            <div id="modalContent"></div>
            <div style="text-align:center; margin-top:1.5rem;">
                <button id="btnModalPrint">üñ®Ô∏è Imprimer</button>
                <button id="btnModalDownload">‚¨áÔ∏è T√©l√©charger</button>
                <button id="btnModalShare">üì§ Partager</button>
            </div>
        </div>
    </div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
        // Questions g√©n√©rales oui/non
        const questionsOuiNon = [
            "Le produit est-il en bon √©tat et est-il complet (produit et accessoires) ?",
            "Le produit pr√©sente-t-il des d√©t√©riorations ou des faiblesses de n'importe quel type ?",
            "Le produit fonctionne-t-il correctement sous charge nominale ?",
            "Le produit est-il compl√®tement fonctionnel conform√©ment au manuel d'utilisation ?",
            "Tous les d√©fauts trouv√©s ont-ils √©t√© √©limin√©s et tous les composants d√©fectueux ont-ils √©t√© remplac√©s ?",
            "Tous les boulons/vis sont-ils fix√©s correctement et le produit est-il mont√© correctement ?",
            "Le produit est-il techniquement et fonctionnellement s√ªr ?",
            "Le produit a-t-il √©t√© nettoy√© et d√©sinfect√© ?",
            "L'autocollant d'identification est-il facilement lisible et est-il fermement appos√© sur le produit ?"
        ];

        // Questions √©tat du produit par type mat√©riel (exemple lit, fauteuil manuel)
        const etatElements = {
            lit: [
                "Barri√®res",
                "Potence",
                "T√™te et pied de lit",
                "Ch√¢ssis",
                "Moteur"
            ],
            fauteuil_manuel: [
                "Roues",
                "Accoudoirs",
                "Freins",
                "Repose-pieds",
                "Toiles (assise et dossier)",
                "Ch√¢ssis"
            ],
            fauteuil_electrique: [
                "Roues",
                "Accoudoirs",
                "Freins",
                "Repose-pieds",
                "Toiles (assise et dossier)",
                "Ch√¢ssis",
                "Batterie",
                "Moteur"
            ],
            leve_personne: [
                "Structure",
                "Sangles",
                "Moteur",
                "Commande",
                "Roues"
            ],
            autre: [
                "√âtat g√©n√©ral des √©l√©ments"
            ]
        };

        const typeSelect = document.getElementById('typeMateriel');
        const questionsContainer = document.getElementById('questionsContainer');
        const btnSummary = document.getElementById('btnSummary');
        const notesContainer = document.getElementById('notes_container');
        const notes = document.getElementById('notes');
        const photosContainer = document.getElementById('photosContainer');
        const photoEnsembleInput = document.getElementById('photoEnsemble');
        const photoEtiquetteInput = document.getElementById('photoEtiquette');
        const previewEnsemble = document.getElementById('previewEnsemble');
        const previewEtiquette = document.getElementById('previewEtiquette');

        let answers = {}; // stocke r√©ponses des questions
        let etatAnswers = {}; // stocke r√©ponses √©tat √©l√©ments
        let photosData = { ensemble: null, etiquette: null };

        // Cr√©e les boutons oui/non
        function createYesNoButtons(questionId, container) {
            const btnsDiv = document.createElement('div');
            btnsDiv.className = 'buttons-choices';

            ['Oui', 'Non'].forEach(text => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.textContent = text;
                btn.addEventListener('click', () => {
                    answers[questionId] = text;
                    // d√©cocher les autres
                    Array.from(btnsDiv.children).forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    checkAllAnswered();
                });
                btnsDiv.appendChild(btn);
            });
            container.appendChild(btnsDiv);
        }

        // Cr√©e les boutons √©tat : bon/moyen/mauvais
        function createEtatButtons(elementId, container) {
            const btnsDiv = document.createElement('div');
            btnsDiv.className = 'buttons-choices';

            ['Bon (RAS)', 'Moyen (Entretien)', 'Mauvais (HS)'].forEach(text => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.textContent = text;
                btn.addEventListener('click', () => {
                    etatAnswers[elementId] = text;
                    Array.from(btnsDiv.children).forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    checkAllAnswered();
                });
                btnsDiv.appendChild(btn);
            });
            container.appendChild(btnsDiv);
        }

        // Affiche les questions + √©tat en fonction du mat√©riel
        typeSelect.addEventListener('change', () => {
            answers = {};
            etatAnswers = {};
            btnSummary.disabled = true;
            questionsContainer.innerHTML = '';
            notesContainer.style.display = 'none';
            photosContainer.style.display = 'none';
            previewEnsemble.src = '';
            previewEtiquette.src = '';
            photosData = { ensemble: null, etiquette: null };

            const type = typeSelect.value;
            if (!type) return;

            // Questions oui/non
            questionsOuiNon.forEach((q, i) => {
                const qid = `q${i}`;
                const div = document.createElement('div');
                div.className = 'question';
                const p = document.createElement('p');
                p.textContent = q;
                div.appendChild(p);
                createYesNoButtons(qid, div);
                questionsContainer.appendChild(div);
            });

            // Questions √©tat
            if (etatElements[type]) {
                etatElements[type].forEach((element, i) => {
                    const eid = `etat${i}`;
                    const div = document.createElement('div');
                    div.className = 'question';
                    const p = document.createElement('p');
                    p.textContent = element;
                    div.appendChild(p);
                    createEtatButtons(eid, div);
                    questionsContainer.appendChild(div);
                });
            }

            notesContainer.style.display = 'block';
            photosContainer.style.display = 'block';
        });

        // Preview photos
        photoEnsembleInput.addEventListener('change', e => {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = () => {
                    previewEnsemble.src = reader.result;
                    photosData.ensemble = reader.result;
                    checkAllAnswered();
                };
                reader.readAsDataURL(file);
            } else {
                previewEnsemble.src = '';
                photosData.ensemble = null;
                checkAllAnswered();
            }
        });

        photoEtiquetteInput.addEventListener('change', e => {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = () => {
                    previewEtiquette.src = reader.result;
                    photosData.etiquette = reader.result;
                    checkAllAnswered();
                };
                reader.readAsDataURL(file);
            } else {
                previewEtiquette.src = '';
                photosData.etiquette = null;
                checkAllAnswered();
            }
        });

        // V√©rifie que toutes les questions ont une r√©ponse + photos s√©lectionn√©es
        function checkAllAnswered() {
            // Tous les oui/non doivent avoir une r√©ponse
            const qOk = questionsOuiNon.length === Object.keys(answers).length;

            // Tous les √©tats doivent avoir une r√©ponse
            const type = typeSelect.value;
            const etatCount = etatElements[type] ? etatElements[type].length : 0;
            const etatOk = etatCount === Object.keys(etatAnswers).length;

            // Photos obligatoires
            const photosOk = photosData.ensemble !== null && photosData.etiquette !== null;

            btnSummary.disabled = !(qOk && etatOk && photosOk);
        }

        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modalContent');
        const closeModal = document.getElementById('closeModal');
        const btnModalPrint = document.getElementById('btnModalPrint');
        const btnModalDownload = document.getElementById('btnModalDownload');
        const btnModalShare = document.getElementById('btnModalShare');

        // G√©n√®re le r√©sum√© HTML
        function generateSummaryHTML() {
            const type = typeSelect.options[typeSelect.selectedIndex].text;
            const dt = new Date();
            const dateStr = dt.toLocaleString('fr-FR', { dateStyle: 'full', timeStyle: 'short' });

            let html = `
                <h1>Rapport de contr√¥le - ${type}</h1>
                <p>Date: ${dateStr}</p>
                <hr />
                <h2>Questions g√©n√©rales</h2>
            `;

            questionsOuiNon.forEach((q, i) => {
                const qid = `q${i}`;
                const rep = answers[qid] || "Non r√©pondu";
                html += `<div class="question-summary"><strong>${q}</strong><br>R√©ponse : ${rep}</div>`;
            });

            html += `<hr /><h2>√âtat des √©l√©ments</h2>`;
            const typeKey = typeSelect.value;
            if (etatElements[typeKey]) {
                etatElements[typeKey].forEach((el, i) => {
                    const eid = `etat${i}`;
                    const rep = etatAnswers[eid] || "Non renseign√©";
                    html += `<div class="question-summary"><strong>${el}</strong><br>√âtat : ${rep}</div>`;
                });
            }

            html += `<hr /><h2>Notes</h2><p>${notes.value.trim() ? notes.value.trim().replace(/\n/g, "<br>") : "Aucune note"}</p>`;

            html += `<hr /><h2>Photos</h2>`;
            if (photosData.ensemble) {
                html += `<p><strong>Photo de l'ensemble :</strong><br><img src="${photosData.ensemble}" alt="Photo de l'ensemble" /></p>`;
            } else {
                html += `<p><strong>Photo de l'ensemble :</strong> Non fournie</p>`;
            }
            if (photosData.etiquette) {
                html += `<p><strong>Photo de l'√©tiquette :</strong><br><img src="${photosData.etiquette}" alt="Photo de l'√©tiquette" /></p>`;
            } else {
                html += `<p><strong>Photo de l'√©tiquette :</strong> Non fournie</p>`;
            }

            return html;
        }

        // Ouvre la modale avec le r√©sum√©
        btnSummary.addEventListener('click', () => {
            const html = generateSummaryHTML();
            modalContent.innerHTML = html;
            modal.style.display = 'block';

            // Pour utiliser dans les fonctions print/download/share
            modalContent.dataset.html = html;
        });

        // Fermer modale
        closeModal.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        // Imprimer le contenu de la modale
        btnModalPrint.addEventListener('click', () => {
            const html = modalContent.dataset.html || '';
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(`
                <html><head><title>Impression Rapport</title><meta charset="UTF-8" />
                <style>body{font-family:Arial,sans-serif; max-width:600px; margin:auto; padding:1rem;}
                img{max-width:50vw; margin-top:0.5rem; border:1px solid #ccc; border-radius:5px;}
                h1,h2{text-align:center;}</style>
                </head><body>${html}
            `);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        });


btnModalDownload.addEventListener('click', async () => {
    try {
        // S'assurer que toutes les images sont charg√©es avant export
        const images = modalContent.querySelectorAll('img');
        for (const img of images) {
            if (!img.complete) {
                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = reject;
                });
            }
        }

        // G√©n√©ration directe depuis le contenu affich√© (sans clone)
        await html2pdf().set({
            margin: 10,
            filename: 'rapport_controle.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).from(modalContent).save();

    } catch (e) {
        alert("Erreur lors du t√©l√©chargement : " + (e.message || e));
    }
});

        // Partager via Web Share API
        // btnModalShare.addEventListener('click', async () => {
        //     const html = modalContent.dataset.html || '';
        //     const blob = new Blob([html], { type: 'text/html' });
        //     const file = new File([blob], 'rapport_controle.html', { type: 'text/html' });

        //     try {
        //         if (navigator.canShare && navigator.canShare({ files: [file] })) {
        //             await navigator.share({
        //                 title: 'Rapport de contr√¥le',
        //                 text: 'Voici le rapport de retour mat√©riel m√©dical.',
        //                 files: [file]
        //             });
        //         } else {
        //             alert("Le partage n‚Äôest pas support√© sur ce navigateur.");
        //         }
        //     } catch (err) {
        //         alert("√âchec du partage : " + err.message);
        //     }
        // });

        btnModalShare.addEventListener('click', async () => {
    try {
        const canvas = await html2canvas(modalContent, { scale: 2, useCORS: true });
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
        const file = new File([blob], 'rapport.png', { type: 'image/png' });

        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            await navigator.share({
                title: 'Rapport visuel',
                text: 'Voici le rapport de retour mat√©riel m√©dical.' + '\n' + modalContent,
                files: [file]
            });
        } else {
            // Fallback : t√©l√©chargement
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'rapport.png';
            link.click();
            URL.revokeObjectURL(link.href);
        }
    } catch (err) {
        alert("Erreur lors du partage : " + err.message);
    }
});

        // Fermer modale au clic hors contenu
        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    </script>

</body>

</html>
