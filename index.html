<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="shortcut icon" href="./assets/icons/192.png" type="image/x-icon">
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json" />
    <title>Contr√¥le Mat√©riel M√©dical</title>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').then(registration => {
                console.log('Service Worker enregistr√©', registration);

                // üîÑ Surveille les mises √† jour
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    if (!newWorker) return;

                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed') {
                            if (navigator.serviceWorker.controller) {
                                // ‚úÖ Nouvelle version pr√™te
                                showUpdateNotification();
                            }
                        }
                    });
                });
            }).catch(err => {
                console.error('Erreur lors de l‚Äôenregistrement du Service Worker :', err);
            });
        }

        function showUpdateNotification() {
            const banner = document.createElement('div');
            banner.style.position = 'fixed';
            banner.style.bottom = '0';
            banner.style.left = '0';
            banner.style.right = '0';
            banner.style.background = '#333';
            banner.style.color = 'white';
            banner.style.padding = '1rem';
            banner.style.display = 'flex';
            banner.style.justifyContent = 'space-between';
            banner.style.alignItems = 'center';
            banner.style.zIndex = '9999';
            banner.innerHTML = `
                <span>üîÑ Nouvelle version disponible</span>
                <button style="padding:0.5rem 1rem; background:#00c853; color:white; border:none; border-radius:4px; cursor:pointer;">
                    Mettre √† jour
                </button>
            `;

            banner.querySelector('button').addEventListener('click', () => {
                window.location.reload(); // Recharge l'app avec la nouvelle version
            });

            document.body.appendChild(banner);
        }

    </script>
</head>

<body>

    <header>
        <!-- Bouton pour ouvrir la modale -->
        <button id="btnSettings">Param√®tres</button>

        <!-- Modale -->
        <div id="settingsModal" style="display: none;">
            <h3>Param√®tres</h3>
            <label for="cameraSelect">Choisir une cam√©ra :</label>
            <select id="cameraSelect"></select>
            <br><br>
            <button id="saveSettings">Enregistrer</button>
            <button id="closeSettingsModal">Fermer</button>
        </div>

    </header>

    <h1>Contr√¥le Mat√©riel M√©dical</h1>

    <button id="btnScan">üì∑ Scanner code-barres</button>
    <button id="endScan" title="Arreter le scan">‚úñÔ∏è</button>

    <div id="scanner"></div>

    <label for="serial_number">Num√©ro de s√©rie</label>
    <input type="text" id="serial_number">

    <label for="typeMateriel">Choisir le type de mat√©riel :</label>
    <select id="typeMateriel" required>
        <option value="">-- S√©lectionner --</option>
        <option value="lit">Lit m√©dicalis√©</option>
        <option value="fauteuil_manuel">Fauteuil roulant manuel</option>
        <option value="fauteuil_electrique">Fauteuil roulant √©lectrique</option>
        <option value="leve_personne">L√®ve-personne / verticalisateur</option>
        <option value="autre">Autre</option>
    </select>

    <div id="questionsContainer" class="questions"></div>

    <div class="notes_container" id="notes_container">
        <label for="notes">Notes :</label>
        <textarea name="notes" id="notes"></textarea>
    </div>

    <div id="photosContainer" style="margin-top:1.5rem; display:none;">
        <label>Photo de l'ensemble :</label>
        <input type="file" accept="image/*" capture="environment" id="photoEnsemble" />
        <img id="previewEnsemble" class="preview" alt="Aper√ßu photo ensemble" />

        <label>Photo de l'√©tiquette (n¬∞ de s√©rie) :</label>
        <input type="file" accept="image/*" capture="environment" id="photoEtiquette" />
        <img id="previewEtiquette" class="preview" alt="Aper√ßu photo √©tiquette" />
    </div>

    <button id="btnSummary" disabled>Voir r√©sum√© & Partager</button>

    <!-- Modale r√©sum√© -->
    <div id="modal">
        <div>
            <button id="closeModal" title="Fermer la fen√™tre">‚úñÔ∏è</button>
            <div id="modalContent"></div>
            <div style="text-align:center; margin-top:1.5rem;">
                <button id="btnModalPrint">üñ®Ô∏è Imprimer</button>
                <button id="btnModalDownload">‚¨áÔ∏è T√©l√©charger</button>
                <button id="btnModalMail">üìß Envoyer par mail</button>
                <button id="btnModalShare">üì§ Partager</button>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script type="module" src="app.js"></script>
</body>

</html>